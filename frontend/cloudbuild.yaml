# cloudbuild.yaml ‚Äî Secure & working version (Node + Secret Manager + Firebase deploy)

steps:
  # Step 1: Install dependencies
  - name: 'node:20'
    entrypoint: 'npm'
    args: ['ci']
    dir: 'frontend'

  # Step 2: Load secrets, build, and deploy
  - name: 'node:20' # Node image includes npm
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîê Loading secrets from Secret Manager..."
        export VITE_CHAT_URL=$(gcloud secrets versions access latest --secret=VITE_CHAT_URL)
        export VITE_SIGN_URL=$(gcloud secrets versions access latest --secret=VITE_SIGN_URL)
        export VITE_FIREBASE_API_KEY=$(gcloud secrets versions access latest --secret=VITE_FIREBASE_API_KEY)
        export VITE_FIREBASE_AUTH_DOMAIN=$(gcloud secrets versions access latest --secret=VITE_FIREBASE_AUTH_DOMAIN)
        export VITE_FIREBASE_PROJECT_ID=$(gcloud secrets versions access latest --secret=VITE_FIREBASE_PROJECT_ID)
        export VITE_FIREBASE_STORAGE_BUCKET=$(gcloud secrets versions access latest --secret=VITE_FIREBASE_STORAGE_BUCKET)
        export VITE_FIREBASE_MESSAGING_SENDER_ID=$(gcloud secrets versions access latest --secret=VITE_FIREBASE_MESSAGING_SENDER_ID)
        export VITE_FIREBASE_APP_ID=$(gcloud secrets versions access latest --secret=VITE_FIREBASE_APP_ID)
        export VITE_FIREBASE_MEASUREMENT_ID=$(gcloud secrets versions access latest --secret=VITE_FIREBASE_MEASUREMENT_ID)

        echo "‚úÖ Secrets loaded successfully"
        cd frontend

        echo "üèóÔ∏è Building production app..."
        npm run build

        echo "üöÄ Deploying to Firebase Hosting..."
        npm install -g firebase-tools
        firebase experiments:enable webframeworks
        firebase deploy --only hosting --project ai-data-analyser --non-interactive

# Optional: reduce logs
options:
  logging: CLOUD_LOGGING_ONLY
